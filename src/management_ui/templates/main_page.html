<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main_page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='js/main_page.js') }}">
    <title>Fatial Recognition</title>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header p-3">
            <h4>Facial Recognition</h4>
        </div>
        <div>
            <img class="logo" src="https://portal.huflit.edu.vn/Content/logo/logologinhuflit.png" alt="">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="#" id="manage-classes">Quản lý lớp học</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="manage-students">Quản lý sinh viên</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="attendance-system">Điểm danh</a>
            </li>
        </ul>
        <div class="account-area">
            <div class="dropdown">
                <a class="dropdown-toggle user-link" href="#" role="button" data-toggle="dropdown"
                    aria-expanded="false">
                    <img style="width: 40px; height: 40px; border-radius: 50%; margin-right: 5px;"
                        src="https://static.vecteezy.com/system/resources/thumbnails/009/292/244/small/default-avatar-icon-of-social-media-user-vector.jpg"
                        alt="">
                    <h6>Thu Hằng</h6>
                </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#"><i class="bi bi-person"></i> Thông tin tài khoản</a>
                    <a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a>
                </div>
            </div>
        </div>
    </div>
    <div class="main-content">
        <nav class="nav-header">
            <div>
                <span class="toggle-button" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </span>
                <a href="#" id="header-link" class="header-link">
                    <i class="bi bi-card-list"></i>
                    <span id="header-text">Danh sách các lớp</span>
                </a>
            </div>
            <div style="display: flex;">
                <form class="form-search">
                    <input type="text" id="search-input" class="form-control" placeholder="Tìm kiếm">
                    <button class="btn btn-info" type="button"><i class="bi bi-search"></i></button>
                </form>
                <button class="btn btn-outline-secondary" style="margin-left: 10px;"><i class="bi bi-plus-lg"></i></button>
            </div>
        </nav>
        <div id="content-area" class="container-content" style="width: 100%;">
<!--            Hiện bảng dữ liệu-->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"
        integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+"
        crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            let studentsDataByClass = []; // Biến toàn cục để lưu dữ liệu sinh viên theo lớp

            $('#manage-classes').on('click', function (event) {
                event.preventDefault();
                $('#header-link').attr('href', '#');
                $('#header-text').text('Danh sách các lớp');
                loadClasses();
                localStorage.setItem('currentPage', 'classes');
            });

            $('#manage-students').on('click', function (event) {
                event.preventDefault();
                $('#header-link').attr('href', '#');
                $('#header-text').text('Danh sách sinh viên');
                loadStudents();
                localStorage.setItem('currentPage', 'students');
            });

            // Add an event listener for the attendance system
            $('#attendance-system').on('click', function (event) {
                event.preventDefault();
                $('#header-link').attr('href', '#');
                $('#header-text').text('Điểm danh');

                // Send a request to start the attendance system
                fetch('/start_attendance')
                    .then(response => {
                        if (response.ok) {
                            alert('Attendance system started!');
                        } else {
                            alert('Failed to start attendance system.');
                        }
                    })
                    .catch(error => {
                        console.error('Error starting attendance system:', error);
                    });
            });

            $('#search-input').on('input', function () {
                let searchText = $(this).val().toLowerCase();
                if ($('#header-text').text() === 'Danh sách các lớp') {
                    filterClasses(searchText);
                } else if ($('#header-text').text() === 'Danh sách sinh viên' || $('#header-text').text() === 'Danh sách sinh viên trong lớp') {
                    filterStudents(searchText);
                }
            });

            function loadClasses() {
                $('#content-area').html(`
                    <table class="table" style="width: 100%;">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Mã lớp</th>
                                <th scope="col">Tên môn</th>
                                <th scope="col">Ca học</th>
                                <th scope="col">Thứ</th>
                                <th scope="col">Thời gian học</th>
                                <th scope="col">Giảng viên</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="classes-table-body">
                        </tbody>
                    </table>
                `);
                fetch('/get_classes').then(response => response.json()).then(data => {
                    window.classesData = data; // Lưu dữ liệu vào biến toàn cục để sử dụng cho tìm kiếm
                    displayClasses(data);
                });
            }

            function loadStudents() {
                $('#content-area').html(`
                    <table class="table" style="width: 100%;">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Mã sinh viên</th>
                                <th scope="col">Tên sinh viên</th>
                                <th scope="col">Giới tính</th>
                                <th scope="col">Lớp</th>
                                <th scope="col">Dữ liệu</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                        </tbody>
                    </table>
                `);
                fetch('/get_students').then(response => response.json()).then(data => {
                    window.studentsData = data; // Lưu dữ liệu vào biến toàn cục để sử dụng cho tìm kiếm
                    displayStudents(data);
                });
            }

            function loadStudentsByClass(classId) {
                fetch(`/get_students_by_class?class_id=${classId}`)
                    .then(response => response.json())
                    .then(data => {
                        studentsDataByClass = data; // Lưu dữ liệu vào biến toàn cục
                        displayStudentsByClass(data);
                        localStorage.setItem('currentPage', 'studentsByClass');
                        localStorage.setItem('currentClassId', classId);
                    });
            }

            function displayClasses(data) {
                let rows = '';
                data.forEach((cls, index) => {
                    rows += `
                        <tr data-class-id="${cls.id}">
                            <th scope="row">${index + 1}</th>
                            <td>${cls.id}</td>
                            <td>${cls.subjectName}</td>
                            <td>${cls.name}</td>
                            <td>${cls.day_of_week}</td>
                            <td>${cls.start_date} -> ${cls.end_date}</td>
                            <td>${cls.teacherName}</td>
                            <td>
                                <button class="btn btn-outline-info"><i class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-danger"><i class="bi bi-trash3-fill"></i></button>
                            </td>
                        </tr>
                    `;
                });
                $('#classes-table-body').html(rows);

                // Thêm sự kiện click vào từng hàng
                $('#classes-table-body tr').on('click', function () {
                    let classId = $(this).data('class-id');
                    $('#header-link').attr('href', '#');
                    $('#header-text').text('Danh sách sinh viên trong lớp');
                    loadStudentsByClass(classId);
                });
            }

            function displayStudents(data) {
                let rows = '';
                data.forEach((student, index) => {
                    const hasFacesData = student.facesData && student.facesData.length > 0;
                    rows += `
                        <tr>
                            <th scope="row">${index + 1}</th>
                            <td>${student.studentID}</td>
                            <td>${student.name}</td>
                            <td>${student.sex}</td>
                            <td>${student.className}</td>
                            <td>
                                ${hasFacesData ?
                                    `<a href="/addDB?student_id=${student.studentID}&name=${student.name}&class_name=${student.className}" class="btn btn-check"><i class="bi bi-check-circle-fill text-success"></i></a>` :
                                    `<a href="/addDB?student_id=${student.studentID}&name=${student.name}&class_name=${student.className}" class="btn btn-plus"><i class="bi bi-plus-circle-fill text-danger"></i></a>`
                                }
                            </td>
                        </tr>
                    `;
                });
                $('#students-table-body').html(rows);
            }

            function displayStudentsByClass(data) {
                let rows = '';
                data.forEach((student, index) => {
                    rows += `
                        <tr>
                            <th scope="row">${index + 1}</th>
                            <td>${student.studentID}</td>
                            <td>${student.name}</td>
                            <td>${student.total_sessions}</td>
                            <td>${student.absences}</td>
                        </tr>
                    `;
                });
                $('#content-area').html(`
                    <table class="table" style="width: 100%;">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Mã sinh viên</th>
                                <th scope="col">Tên sinh viên</th>
                                <th scope="col">Số buổi học</th>
                                <th scope="col">Số buổi vắng</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            ${rows}
                        </tbody>
                    </table>
                `);
            }

            function filterClasses(searchText) {
                let filteredClasses = window.classesData.filter(cls =>
                    cls.id.toLowerCase().includes(searchText) ||
                    cls.subjectName.toLowerCase().includes(searchText) ||
                    cls.name.toLowerCase().includes(searchText) ||
                    cls.teacherName.toLowerCase().includes(searchText)
                );
                displayClasses(filteredClasses);
            }

            function filterStudents(searchText) {
                let filteredStudents = window.studentsData.filter(student =>
                    student.studentID.toLowerCase().includes(searchText) ||
                    student.name.toLowerCase().includes(searchText) ||
                    student.sex.toLowerCase().includes(searchText) ||
                    student.className.toLowerCase().includes(searchText)
                );

                // Kiểm tra xem hiện tại đang hiển thị danh sách sinh viên của lớp hay không
                if ($('#header-text').text() === 'Danh sách sinh viên trong lớp') {
                    filteredStudents = studentsDataByClass.filter(student =>
                        student.studentID.toLowerCase().includes(searchText) ||
                        student.name.toLowerCase().includes(searchText)
                    );
                    displayStudentsByClass(filteredStudents);
                } else {
                    displayStudents(filteredStudents);
                }
            }

            // Kiểm tra trạng thái khi tải lại trang
            const currentPage = localStorage.getItem('currentPage');
            if (currentPage === 'studentsByClass') {
                const classId = localStorage.getItem('currentClassId');
                $('#header-link').attr('href', '#');
                $('#header-text').text('Danh sách sinh viên trong lớp');
                loadStudentsByClass(classId);
            } else if (currentPage === 'students') {
                $('#header-link').attr('href', '#');
                $('#header-text').text('Danh sách sinh viên');
                loadStudents();
            } else {
                $('#header-link').attr('href', '#');
                $('#header-text').text('Danh sách các lớp');
                loadClasses();
            }
        });

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-hidden');
        }
    </script>
</body>
</html>